<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Class Maker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <style>


    </style>
</head>
<body>

<!-- THIS HIDES AND SHOWS VEIL -->
<!--<div id="landscape_veil" class="landscape_veil"><h2>Turn your phone please. </h2></div>-->

<!-- NAVIGATION -->
<nav id="toolbar" class="toolbar">
    <div id="logo" class="logo">Class Maker</div>
    <div id="menuButton" class="menuButton fa fa-bars"></div>
</nav>

<!-- PAGE CONTAINER-->
<div id="container" class="container">

    <!-- ADD BUTTON-->
    <div id="add_button" class="add_button fa fa-user-plus "></div>

    <!-- STUDENT FORM -->
    <div id="student_form_container" class="student_form_container">
        <form id="student_form" method="POST" action="/">

            <div class="text_input_field">
                <label for="student_id_input"> student id </label>
                <input id="student_id_input" name="student_id_input" type="text" autocomplete="off" placeholder="">
            </div>

            <div class="text_input_field">
                <label for="student_firstname_input"> first name </label>
                <input id="student_firstname_input" name="student_firstname_input" type="text" autocomplete="off" placeholder="">
            </div>

            <div class="text_input_field">
                <label for="student_lastname_input"> last name </label>
                <input id="student_lastname_input" name="student_lastname_input" type="text" autocomplete="off" placeholder="">
            </div>
            <br>
            <label for="behavior">behavior</label> <br> <span>(poor)</span>
            <input name="behavior" type="radio" value="1">
            <input name="behavior" type="radio" value="2">
            <input name="behavior" type="radio" value="3">
            <input name="behavior" type="radio" value="4">
            <input name="behavior" type="radio" value="5">
            <input name="behavior" type="radio" value="6">
            <input name="behavior" type="radio" value="7">
            <input name="behavior" type="radio" value="8">
            <input name="behavior" type="radio" value="9">
            <input name="behavior" type="radio" value="10"> (great)
            <br> <br>

            <label for="math">math </label> <br> <span>(poor)</span>
            <input name="math" type="radio" value="1">
            <input name="math" type="radio" value="2">
            <input name="math" type="radio" value="3">
            <input name="math" type="radio" value="4">
            <input name="math" type="radio" value="5">
            <input name="math" type="radio" value="6">
            <input name="math" type="radio" value="7">
            <input name="math" type="radio" value="8">
            <input name="math" type="radio" value="9">
            <input name="math" type="radio" value="10"> (great)
            <br> <br>

            <label for="english">english </label> <br> <span>(poor)</span>
            <input name="english" type="radio" value="1">
            <input name="english" type="radio" value="2">
            <input name="english" type="radio" value="3">
            <input name="english" type="radio" value="4">
            <input name="english" type="radio" value="5">
            <input name="english" type="radio" value="6">
            <input name="english" type="radio" value="7">
            <input name="english" type="radio" value="8">
            <input name="english" type="radio" value="9">
            <input name="english" type="radio" value="10"> (great)
            <br> <br>

            <label for="science">science </label> <br ><span>(poor)</span>
            <input name="science" type="radio" value="1">
            <input name="science" type="radio" value="2">
            <input name="science" type="radio" value="3">
            <input name="science" type="radio" value="4">
            <input name="science" type="radio" value="5">
            <input name="science" type="radio" value="6">
            <input name="science" type="radio" value="7">
            <input name="science" type="radio" value="8">
            <input name="science" type="radio" value="9">
            <input name="science" type="radio" value="10"> (great)
            <br> <br>

            <div>
                <button id="student_form_cancel_button">Cancel</button>
                <button id="student_form_save_button" type="submit">Save</button>
            </div>
        </form>
    </div>

    <div id="student_form_veil" class="student_form_veil"></div>


    <!-- MAIN MENU -->
    <div id="menu" class="menu">
        <ul>
            <li class="menu_item">(email)</li>
            <li class="menu_item">Profile</li>
            <li class="menu_item">Settings</li>
            <li class="menu_item">Help</li>
            <li class="menu_item">Log Out</li>
        </ul>
    </div>
    <div class="modal_veil"></div>

    <!-- STUDENT VIEW -->
    <div class="students_title"> Students </div>
    <div id="students_view" class="students_view">
        <!-- DYNAMICALLY CREATE ELEMENTS HERE -->
    </div>

</div>
<!-- MAIN MENU - END -->



<script src="js/logic_toolbar.js"></script>

<script>

    var student_form_container = document.getElementById('student_form_container');
    var student_form_veil = document.getElementById('student_form_veil');
    var student_form_cancel_button = document.getElementById('student_form_cancel_button');
    var student_form_save_button = document.getElementById('student_form_save_button');


    var add_student_button = document.getElementById('add_button');

    // FUNCTIONS ----------------
    function update_view(data_object, target_div) {

        data_object.forEach(function(elem, ind, arr){

            var self = this;

            // CREATES & ASSIGNS -------
            var div = document.createElement('div');
            div.id = data_object[ind].student_id;

            var img = document.createElement('img');
            img.src = 'images/penguin_sm.jpg';

            var score_div = document.createElement('div');
            score_div.classList.add('score');

            // DATA CHECK
            score_div.innerHTML = get_average_score(data_object[ind]);


            var name_div = document.createElement('div');
            score_div.classList.add('name');
            name_div.innerHTML = data_object[ind].firstname + ' ' + data_object[ind].lastname;

            // EVENT LISTENERS --------
            div.onclick = function(e) {
                console.log(div.id);

                //TODO: wrap into an 'update' function.
//                set_student_input_form_values(
//                    div.id, data_object[ind].firstname,
//                    data_object[ind].lastname,
//                    data_object[ind].stats.behavior,
//                    data_object[ind].stats.math,
//                    data_object[ind].stats.english,
//                    data_object[ind].stats.science
//                );

                console.log(data_object[ind].stats.behavior);

                // catch the zeros
                if(data_object[ind].stats.behavior == 0) {data_object[ind].stats.behavior = 1;}
                if(data_object[ind].stats.math == 0) {data_object[ind].stats.math = 1;}
                if(data_object[ind].stats.english == 0) {data_object[ind].stats.english = 1;}
                if(data_object[ind].stats.science == 0) {data_object[ind].stats.science = 1;}



                set_student_input_form_values(div.id, data_object[ind].firstname,
                    data_object[ind].lastname,
                    data_object[ind].stats.behavior,
                    data_object[ind].stats.math,
                    data_object[ind].stats.english,
                    elem.stats.science);

                toggle_student_input_modal();
            };

            // APPENDS -------
            div.appendChild(img);
            div.appendChild(score_div);
            div.appendChild(name_div);

            target_div.appendChild(div);
        });
    }

    function refresh_view() {
        // clear
        document.getElementById('students_view').innerHTML = '';

        $.ajax({
            method: 'GET',
            url: '/api/student',
            success: function(data, status, jqxhr) {
                console.log(data.payload);
                update_view(data.payload.students, document.getElementById('students_view'));
            },
            error: function(jqxhr, status, err) {
                console.log(err);
            }
        });
    }

    function get_average_score(data_object) {
        return ((data_object.stats.behavior + data_object.stats.math + data_object.stats.english + data_object.stats.science) / 4).toFixed(1);
    }

    function toggle_student_input_modal() {

        if(student_form_container.classList.contains('hide')) {
            student_form_container.classList.remove('hide');
            student_form_veil.classList.remove('hide');
        } else {
            student_form_container.classList.add('hide');
            student_form_veil.classList.add('hide');
        }
    }

    function clear_student_input_form_values() {
        document.getElementById('student_id_input').value = '';
        document.getElementById('student_firstname_input').value = '';
        document.getElementById('student_lastname_input').value = '';

        $('input[name=behavior]:checked').prop('checked', false);
        $('input[name=math]:checked').prop('checked', false);
        $('input[name=english]:checked').prop('checked', false);
        $('input[name=science]:checked').prop('checked', false);
    }

    function set_student_input_form_values(student_id, firstname, lastname, behavior, math, english, science) {
        document.getElementById('student_id_input').value = student_id;
        document.getElementById('student_firstname_input').value = firstname;
        document.getElementById('student_lastname_input').value = lastname;

//        $('input[name=behavior]')[parseInt(behavior)-1].checked = true;
//        $('input[name=math]:checked')[parseInt(math)-1].checked = true;
//        $('input[name=english]:checked')[parseInt(english)-1].checked = true;
//        $('input[name=science]:checked')[parseInt(science)-1].checked = true;

        $('input[name=behavior]')[behavior-1].checked = true;
        $('input[name=math]')[math-1].checked = true;
        $('input[name=english]')[english-1].checked = true;
        $('input[name=science]')[science-1].checked = true;

        // TODO: must override 'save' button to launch an 'update' function.
        student_form_save_button.innerHTML = 'update';
        student_form_save_button.onclick = function(e) {
            e.preventDefault();
            update_student();
        };
    }

    function add_new_student() {
        var student_id = document.getElementById('student_id_input').value;
        var student_firstname = document.getElementById('student_firstname_input').value;
        var student_lastname = document.getElementById('student_lastname_input').value;

        var student_behavior = $('input[name=behavior]:checked').val();
        var student_math = $('input[name=math]:checked').val();
        var student_english = $('input[name=english]:checked').val();
        var student_science = $('input[name=science]:checked').val();

        //DEBUG

        send_object = {
            user: user_data_object.user,
            student_id: parseInt(student_id),
            student_firstname: student_firstname,
            student_lastname: student_lastname,
            student_behavior: parseInt(student_behavior) || 1,
            student_math: parseInt(student_math) || 1,
            student_english: parseInt(student_english) || 1,
            student_science: parseInt(student_science) || 1
        };

        console.log(send_object);

        $.ajax({
            method: 'POST',
            url: '/api/student',
            data: send_object,
            success: function(data, status, jqxhr) {
                console.log('successfully added student, refreshing page.');

                // TODO:
                refresh_view();
            },
            error: function(jqxhr, status, err) {
                console.log('error saving student.' + err);
            }

        });
    }

    // user, student_id, firstname, lastname (all these to identify student)
    function update_student() {

        //TODO: STORE CURRENT DATA FOR SEARCH.
        //TODO: STORE NEW DATA FOR UPDATE.

        console.log('TODO: update student with PUT. ');

        var student_id = document.getElementById('student_id_input').value;
        var student_firstname = document.getElementById('student_firstname_input').value;
        var student_lastname = document.getElementById('student_lastname_input').value;

        var student_behavior = $('input[name=behavior]:checked').val();
        var student_math = $('input[name=math]:checked').val();
        var student_english = $('input[name=english]:checked').val();
        var student_science = $('input[name=science]:checked').val();

        //DEBUG

        send_object = {
            user: user_data_object.user,
            student_id: parseInt(student_id),
            student_firstname: student_firstname,
            student_lastname: student_lastname,
            student_behavior: parseInt(student_behavior) || 1,
            student_math: parseInt(student_math) || 1,
            student_english: parseInt(student_english) || 1,
            student_science: parseInt(student_science) || 1
        };

        console.log(send_object);

        $.ajax({
            method: 'PUT',
            url: '/api/student',
            data: send_object,
            success: function(data, status, jqxhr) {
                console.log('successfully updated student, refreshing page.');

                // TODO:
                refresh_view();
                toggle_student_input_modal();
            },
            error: function(jqxhr, status, err) {
                console.log('error saving student.' + err);
            }

        });
    }



    // EVENTS --------------------
    window.addEventListener('DOMContentLoaded', function(e){

        toggle_student_input_modal();

        $.ajax({
            method: 'GET',
            url: '/api/student',
            success: function(data, status, jqxhr) {
                console.log(data.payload);
                update_view(data.payload.students, document.getElementById('students_view'));
            },
            error: function(jqxhr, status, err) {
                console.log(err);
            }
        });
    });

    student_form_cancel_button.onclick = function(e){
        e.preventDefault();
        console.log('cancelled student view');
        toggle_student_input_modal();
    };

    student_form_save_button.onclick = function(e){
        e.preventDefault();
        console.log('student item saved. ');
        toggle_student_input_modal();
        add_new_student();
    };

    add_student_button.onclick = function(e) {
        clear_student_input_form_values();
        toggle_student_input_modal();

        // redefine button to save again.
        student_form_save_button.innerHTML = 'save';
        student_form_save_button.onclick = function(e){
            e.preventDefault();
            console.log('student item saved. ');
            toggle_student_input_modal();
            add_new_student();
        };
    };


    // helper functions ---------
    function capitalize(input) {
        return input[0].toUpperCase() + input.slice(1, input.length);
    }

    // EDIT MODAL FUNCTIONS ---------------
</script>

</body>
</html>